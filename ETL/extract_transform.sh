#!/bin/bash

# Script to download Common Core Data, transform and extract columns
# Execute: ./extract_transform.sh
# Reads: fiscal.txt and nonfiscal*.txt files containing URLs
# Outputs: fiscal.csv and nonfiscal.csv files

# Fiscal Common Core Data

for url in `cat fiscal.txt`; do 

if ! wget $url -O temp.zip; then
  echo "ERROR: can't get archive $url" >&2
  exit 1
fi

unzip -p temp.zip | sed 's/\t/,/g' | while IFS=$',' read -r survey_year FIPS state STNAME R1A R1B R1C R1D R1E R1F R1G R1H R1I R1J R1K R1L R1M R1N local_revenue R2 state_revenue R4A R4B R4C R4D federal_revenue R5 total_revenue teacher_salaries teacher_benefits E13 E14 E15 E16 E17 E18 STE1 E11A E11B E11C E11D E2 E212 E213 E214 E215 E216 E217 E218 TE21 E222 E223 E224 E225 E226 E227 E228 TE22 E232 E233 E234 E235 E236 E237 E238 TE23 E242 E243 E244 E245 E246 E247 E248 TE24 E252 E253 E254 E255 E256 E257 E258 TE25 E262 E263 E264 E265 E266 E267 E268 TE26 STE22 STE23 STE24 STE25 STE26 STE27 STE28 STE2T E3A11 E3A12 E3A13 E3A14 E3A2 E3A16 E3A1 E3B11 E3B12 E3B13 E3B14 E3B2 E3B16 E3B1 STE3 E4A1 E4A2 E4B1 E4B2 E4C1 E4C2 E4D E4E1 E4E2 STE4 current_expenditures E61 E62 E63 STE6 E7A1 E7A2 STE7 E81 E82 E9A E9B E9C E9D E91 STE9 TE10 TE11 X12C X12D X12E X12F TX12 NCE13 ADA A14A A14B PPE15 MEMBR13 ARRASTE1 ARRATE5 ARRAE81Z ARRATE10 ARRASTE6 ARRATLEIZ ARRASTE4 IR1A IR1B IR1C IR1D IR1E IR1F IR1G IR1H IR1I IR1J IR1K IR1L IR1M IR1N ISTR1 IR2 IR3 IR4A IR4B IR4C IR4D ISTR4 IR5 ITR IE11 IE12 IE13 IE14 IE15 IE16 IE17 IE18 ISTE1 IE11A IE11B IE11C IE11D IE2 IE212 IE213 IE214 IE215 IE216 IE217 IE218 ITE21 IE222 IE223 IE224 IE225 IE226 IE227 IE228 ITE22 IE232 IE233 IE234 IE235 IE236 IE237 IE238 ITE23 IE242 IE243 IE244 IE245 IE246 IE247 IE248 ITE24 IE252 IE253 IE254 IE255 IE256 IE257 IE258 ITE25 IE262 IE263 IE264 IE265 IE266 IE267 IE268 ITE26 ISTE22 ISTE23 ISTE24 ISTE25 ISTE26 ISTE27 ISTE28 ISTE2T IE3A11 IE3A12 IE3A13 IE3A14 IE3A2 IE3A16 IE3A1 IE3B11 IE3B12 IE3B13 IE3B14 IE3B2 IE3B16 IE3B1 ISTE3 IE4A1 IE4A2 IE4B1 IE4B2 IE4C1 IE4C2 IE4D IE4E1 IE4E2 ISTE4 ITE5 IE61 IE62 IE63 ISTE6 IE7A1 IE7A2 ISTE7 IE81 IE82 IE9A IE9B IE9C IE9D IE91 ISTE9 ITE10 ITE11 IX12C IX12D IX12E IX12F ITX12 INCE13 IADA IA14A IA14B IPPE15 IMEMBR13 IARRASTE1 IARRATE5 IARRAE81Z IARRATE10 IARRASTE6 IARRATLEIZ IARRASTE4; do echo "$survey_year,$state,$state_revenue,$local_revenue,$federal_revenue,$total_revenue,$teacher_salaries,$teacher_benefits,$current_expenditures"; done | tail -n +2 | head -n 51 >> fiscal.csv;

wc -l fiscal.csv;
rm temp.zip
done

# Nonfiscal Common Core Data 2008+

for url in `cat nonfiscal1.txt`; do 

if ! wget $url -O temp.zip; then
  echo "ERROR: can't get archive $url" >&2
  exit 1
fi

unzip -p temp.zip | sed 's/,/ /g' | sed 's/\t/,/g' | while IFS=$',' read -r survey_year FIPST state SEANAME STREET CITY STNAME ZIP ZIP4 PHONE PKTCH KGTCH ELMTCH SECTCH UGTCH total_teachers AIDES CORSUP ELMGUI SECGUI OTHGUI TOTGUI LIBSPE LIBSUP LEAADM LEASUP SCHADM SCHSUP STUSUP OTHSUP PK KG G01 G02 G03 G04 G05 G06 G07 grade8_students G09 G10 G11 G12 UG total_students AMPKM AMPKF ASPKM ASPKF HIPKM HIPKF BLPKM BLPKF WHPKM WHPKF HPPKM HPPKF TRPKM TRPKF AMKGM AMKGF ASKGM ASKGF HIKGM HIKGF BLKGM BLKGF WHKGM WHKGF HPKGM HPKGF TRKGM TRKGF AM01M AM01F AS01M AS01F HI01M HI01F BL01M BL01F WH01M WH01F HP01M HP01F TR01M TR01F AM02M AM02F AS02M AS02F HI02M HI02F BL02M BL02F WH02M WH02F HP02M HP02F TR02M TR02F AM03M AM03F AS03M AS03F HI03M HI03F BL03M BL03F WH03M WH03F HP03M HP03F TR03M TR03F AM04M AM04F AS04M AS04F HI04M HI04F BL04M BL04F WH04M WH04F HP04M HP04F TR04M TR04F AM05M AM05F AS05M AS05F HI05M HI05F BL05M BL05F WH05M WH05F HP05M HP05F TR05M TR05F AM06M AM06F AS06M AS06F HI06M HI06F BL06M BL06F WH06M WH06F HP06M HP06F TR06M TR06F AM07M AM07F AS07M AS07F HI07M HI07F BL07M BL07F WH07M WH07F HP07M HP07F TR07M TR07F AM08M AM08F AS08M AS08F HI08M HI08F BL08M BL08F WH08M WH08F HP08M HP08F TR08M TR08F AM09M AM09F AS09M AS09F HI09M HI09F BL09M BL09F WH09M WH09F HP09M HP09F TR09M TR09F AM10M AM10F AS10M AS10F HI10M HI10F BL10M BL10F WH10M WH10F HP10M HP10F TR10M TR10F AM11M AM11F AS11M AS11F HI11M HI11F BL11M BL11F WH11M WH11F HP11M HP11F TR11M TR11F AM12M AM12F AS12M AS12F HI12M HI12F BL12M BL12F WH12M WH12F HP12M HP12F TR12M TR12F AMUGM AMUGF ASUGM ASUGF HIUGM HIUGF BLUGM BLUGF WHUGM WHUGF HPUGM HPUGF TRUGM TRUGF AM AMALM AMALF AS ASALM ASALF HI HIALM HIALF BL BLALM BLALF WH WHALM WHALF HP HPALM HPALF TR TRALM TRALF IPKTCH IKGTCH IELMTCH ISECTCH IUGTCH ITOTTCH IAIDES ICORSUP IELMGUI ISECGUI IOTHGUI ITOTGUI ILIBSPE ILIBSUP ILEAADM ILEASUP ISCHADM ISCHSUP ISTUSUP IOTHSUP IPK IKG IG01 IG02 IG03 IG04 IG05 IG06 IG07 IG08 IG09 IG10 IG11 IG12 IUG IMEMBER; do echo "$survey_year,$state,$total_teachers,$grade8_students,$total_students"; done | tail -n +2 | head -n 51 >> nonfiscal.csv

wc -l nonfiscal.csv;
rm temp.zip
done

# Nonfiscal Common Core Data 2007

for url in `cat nonfiscal2.txt`; do 

if ! wget $url -O temp.zip; then
  echo "ERROR: can't get archive $url" >&2
  exit 1
fi

unzip -p temp.zip | sed 's/,/ /g' | sed 's/\t/,/g' | while IFS=$',' read -r survey_year FIPST state SEANAME STREET CITY STNAME ZIP ZIP4 PHONE PKTCH KGTCH ELMTCH SECTCH UGTCH total_teachers AIDES CORSUP ELMGUI SECGUI TOTGUI LIBSPE LIBSUP LEAADM LEASUP SCHADM SCHSUP STUSUP OTHSUP PK KG G01 G02 G03 G04 G05 G06 G07 grade8_students G09 G10 G11 G12 UG total_students AMPK ASPK HIPK BLPK WHPK AMKG ASKG HIKG BLKG WHKG AM01 AS01 HI01 BL01 WH01 AM02 AS02 HI02 BL02 WH02 AM03 AS03 HI03 BL03 WH03 AM04 AS04 HI04 BL04 WH04 AM05 AS05 HI05 BL05 WH05 AM06 AS06 HI06 BL06 WH06 AM07 AS07 HI07 BL07 WH07 AM08 AS08 HI08 BL08 WH08 AM09 AS09 HI09 BL09 WH09 AM10 AS10 HI10 BL10 WH10 AM11 AS11 HI11 BL11 WH11 AM12 AS12 HI12 BL12 WH12 AMUG ASUG HIUG BLUG WHUG AM AS HI BL WH IPKTCH IKGTCH IELMTCH ISECTCH IUGTCH ITOTTCH IAIDES ICORSUP IELMGUI ISECGUI ITOTGUI ILIBSPE ILIBSUP ILEAADM ILEASUP ISCHADM ISCHSUP ISTUSUP IOTHSUP IPK IKG IG01 IG02 IG03 IG04 IG05 IG06 IG07 IG08 IG09 IG10 IG11 IG12 IUG IMEMBER; do echo "$survey_year,$state,$total_teachers,$grade8_students,$total_students"; done | tail -n +2 | head -n 51 >> nonfiscal.csv

wc -l nonfiscal.csv;
rm temp.zip
done

# Nonfiscal Common Core Data 2003-2006 fixed width 

for url in `cat nonfiscal3.txt`; do 

if ! wget $url -O temp.zip; then
  echo "ERROR: can't get archive $url" >&2
  exit 1
fi

unzip -p temp.zip | sed 's/,/ /g' | sed -r 's/(.{4})(.{2})(.{2})(.{194})(.{6})(.{150})(.{8})(.{40})(.{8})(.{675})/\1,\2,\3,\4,\5,\6,\7,\8,\9,\10/' | while IFS=$',' read -r survey_year FIPST state SKIP total_teachers SKIP grade8_students SKIP total_students SKIP ; do echo "$survey_year,$state,$total_teachers,$grade8_students,$total_students"; done | tail -n +2 | head -n 51 >> nonfiscal.csv

wc -l nonfiscal.csv;
rm temp.zip
done

exit 0

